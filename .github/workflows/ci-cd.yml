name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: "17"

      - name: Build car-backend with Maven
        working-directory: car-backend
        run: |
          chmod +x mvnw
          ./mvnw clean package

      - name: Build text-validation with Maven
        working-directory: text-validation-service
        run: |
          chmod +x mvnw
          ./mvnw clean package

      - name: Build Docker Images
        run: |
          docker build -f car-backend/src/main/docker/Dockerfile.jvm -t ghcr.io/r33bickard/car-backend:latest car-backend
          docker build -f text-validation-service/src/main/docker/Dockerfile.jvm -t ghcr.io/r33bickard/text-validation-service:latest text-validation-service

  performance_tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16"

      # Artillery-Tests
      - name: Install Artillery
        run: npm install -g artillery

      - name: Run Load Test
        run: |
          artillery run src\test\java\com\example\artillery\car-loadtest.yml --output src\test\java\com\example\reports/artillery/car-loadtest-report.json

      - name: Upload Artillery Report
        uses: actions/upload-artifact@v3
        with:
          name: artillery-report
          path: reports/artillery/cattle-loadtest-report.html

      # JMeter-Tests
      - name: Install Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download JMeter
        run: |
          wget https://downloads.apache.org//jmeter/binaries/apache-jmeter-5.6.2.tgz
          tar -xvzf apache-jmeter-5.6.2.tgz

      - name: Run JMeter Test
        run: |
          apache-jmeter-5.6.2/bin/jmeter -n -t src\test\java\com\example\jmeter\cattle-loadtest.jmx -l reports/jmeter/results.jtl -e -o src\test\java\com\example\reports\jmeter

      - name: Upload JMeter Report
        uses: actions/upload-artifact@v3
        with:
          name: jmeter-html-report
          path: reports/jmeter/html-report
